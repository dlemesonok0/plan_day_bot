# Plan Day Bot

FastAPI приложение, которое принимает вебхуки от Telegram, собирает задачи из Todoist и события из Google Calendar, а затем просит бесплатную модель Hugging Face составить тайм-блок расписание на день.

## Возможности

- Команда `/plan` собирает задачи из Todoist и события из Google Calendar на ближайшие 24 часа и просит LLM построить расписание с тайм-блоками.
- Команда `/set_instructions` сохраняет индивидуальные инструкции, которые будут добавлены к плану (повторный вызов без аргументов удаляет инструкции).
- Команда `/adjust_plan` вносит правки в последнее сгенерированное расписание на основе ваших пожеланий.
- Команда `/start` выводит справку по боту.

## Настройка окружения

1. Скопируйте файл `.env.example` в `.env` и заполните значения переменных:

```
cp .env.example .env
```

Обязательные значения:

- `TELEGRAM_BOT_TOKEN` — токен Telegram-бота.
- `TODOIST_API_TOKEN` — API токен Todoist.
- `GOOGLE_SERVICE_ACCOUNT_INFO` — JSON c сервисным аккаунтом Google (одной строкой). Дайте сервисному аккаунту доступ к каждому календарю, который нужно учитывать в расписании.
- `GOOGLE_CALENDAR_ID` — идентификатор одного или нескольких календарей (например, `primary` или `primary,team@example.com`).
- `HUGGINGFACE_API_TOKEN` — токен доступа к Hugging Face Inference API.
- `HUGGINGFACE_MODEL` — (необязательно) имя модели на Hugging Face, по умолчанию используется бесплатная `mistralai/Mistral-7B-Instruct-v0.2`.

### Где взять значения для `.env`

- **TELEGRAM_BOT_TOKEN** — создайте бота у [@BotFather](https://t.me/BotFather) и скопируйте выданный токен.
- **TODOIST_API_TOKEN** — в Todoist откройте *Интеграции → Разработчики → Токен API*.
- **GOOGLE_SERVICE_ACCOUNT_INFO** — в Google Cloud Console включите Google Calendar API для проекта, создайте сервисный аккаунт (достаточно роли `Project → Viewer`), затем выпустите для него JSON-ключ и сохраните содержимое файла в одну строку. Поделитесь каждым нужным календарём с адресом сервисного аккаунта (например, с правами "Просмотр информации о событиях") через интерфейс Google Calendar.
- **GOOGLE_CALENDAR_ID** — `primary` для основного календаря или значение из настроек конкретного календаря. Можно указать несколько идентификаторов через запятую, тогда бот объединит события из всех календарей.
- **HUGGINGFACE_API_TOKEN** — заведите аккаунт на [Hugging Face](https://huggingface.co/), перейдите в *Settings → Access Tokens* и создайте токен с правами `Read`. Бесплатного тарифа достаточно для вызова публичных моделей.
- **HUGGINGFACE_MODEL** — оставьте значение по умолчанию или укажите другую бесплатную модель, опубликованную на Hugging Face Inference API.

2. Установите зависимости:

```
pip install -r requirements.txt
```

## Запуск

### Через Docker Compose

1. Соберите и запустите контейнер:

   ```
   docker compose up --build
   ```

2. Приложение будет доступно на `http://localhost:8000`. Настройте webhook у Telegram бота на `https://<ваш-домен>/webhook` или используйте прокси/туннель до локального сервера.

### Локально (без Docker)

```
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

Настройте webhook у Telegram бота на `https://<ваш-домен>/webhook`.

## Примечания

- Модель получает события и задачи с указанием временной зоны, поэтому итоговое расписание формируется в локальном времени пользователя.
- Хранение инструкций и последнего плана осуществляется в оперативной памяти, поэтому после перезапуска приложения сохранённые данные будут потеряны.
